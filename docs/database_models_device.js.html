<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: database/models/device.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: database/models/device.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Created by eliwinkelman on 9/20/19.
 */

const { DatabaseInterface } = require("../db") ;

const ObjectID = require('mongodb').ObjectID;
var ClientCertFactory = require('../../lib/ClientCertFactory');
var pem = require('pem');
var getKeys = require("../../lib/manageKeys");

class DeviceModel {
	constructor(deviceData) {
		this.name = deviceData.name;
		this.device_id = deviceData.device_id;
		this.fingerprint = deviceData.fingerprint;
		this.owner = deviceData.owner;
		this.coordinator = deviceData.coordinator;
		this.network = deviceData.network;
	}
}

/**
 * Manages database storage for Device objects
 * @implements DatabaseInterface
 * @class
 */
class DeviceDatabase extends DatabaseInterface {

	/**
	 * Helper function to get the collection of devices.
	 * @returns {Object} The MongoDB collection for devices
	 */
	static async getCollection() {
		const collection = await super.getCollection("Devices");
		return collection;
	}

	/**
	 * Determines if user owns the device with id
	 * @param {string} id - The id of the device to check for ownership.
	 * @param {Object} user - The user to check for ownership.
	 * @returns {boolean} True if the user does own the device, false otherwise.
	 */
	static async owns(id, user) {
		return user.devices.includes(id.toString())
	}

	/**
	 * Gets all the devices belonging to this user.
	 * @param {Object} user - A user object
	 * @returns {Array} An array of devices belonging to the user.
	 */
	static async getByUser(user) {

		// check which user role we have to handle
		let usersDevices = [];
		const Devices = await this.getCollection();
		if (user.role == "user") {

			const deviceArray = user.devices.map(device => {
				return ObjectID(device)
			});

			usersDevices = await Devices.find({device_id: {$in: deviceArray}}).toArray().catch(err => {
				throw err;
			});
		}

		else if (user.role == "admin") {
			usersDevices = await Devices.find({}).toArray().catch(err => {
				throw err;
			});
		}

		return usersDevices;
	}

	static async getMany(list) {
		const deviceArray = list.map(device => {
			return ObjectID(device)
		});

		const Devices = await this.getCollection();
		
		const devices = await Devices.find({device_id: {$in: deviceArray}}).toArray().catch(err => {
			throw err;
		});
		
		return devices;
	}
	
	/**
	 * Gets the device with id.
	 * @param {string} id - The id of the device.
	 * @param {Object} user - The user requesting the device.
	 * @returns {Object} A device object from the MongoDB.
	 *
	 * @throws User must own the device.
	 */
	static async get(id, user) {

		this.checkOwnership(id, user);

		const Devices = await this.getCollection();

		var devices = await Devices.find({device_id: new ObjectID(id)}).toArray().catch(err => {
			throw err
		});
		
		return devices[0];
	}

	/**
	 * Updates a device.
	 * @param {string} id - The id of the device to update.
	 * @param {Object} update - The update to apply.
	 * @param {Object} user - The user requesting the update.
	 * @returns {Object} The updated device.
	 *
	 * @throws User must own the device.
	 */
	static async update(id, update, user) {

		this.checkOwnership(id, user);

		const Devices = await this.getCollection();

		let device = {};
		if (this.owns(id, user)) {
			device = await Devices.updateOne({device_id: new ObjectID(id)}, update)
		}
		return device;
	}

	/**
	 * Deletes a device.
	 * @param {string} id - The id of the device to delete.
	 * @param {Object} user - The user attempting to delete the device.
	 * @returns {boolean} True if the device was deleted.
	 *
	 * @throws User must own the device.
	 */
	static async del(id, user) {
		this.checkOwnership(id, user);

		const device = this.get(id, user);
		const Devices = await this.getCollection();
		
		// delete the device
		Devices.deleteOne({device_id: new ObjectID(id)});

		//delete the device data
		const DeviceData = await super.getCollection(id.toString());
		DeviceData.deleteOne({device_id: new ObjectID(id)});

		return true;
	}

	/**
	 * Creates a new device in the database which belongs to user.
	 *
	 * 1. Generate a client certificate and device id for the new device.
	 * 2. Add the new device object to the MongoDB "Devices" collection.
	 * 
	 * @param {string} type - The type of the device.
	 * @param {string} name - The name of the device.
	 * @param {Object} user - The user creating the device.
	 * @returns {{device_id: string, certificate: string?, private_key: string?}} An object containing the authentication information for the device.
	 */
	static async create(name, coordinator, user, network_id) {
		
		//generate a device_id
		const device_id = new ObjectID();

		let new_device = new DeviceModel({
			name: name,
			device_id: device_id,
			owner: user._id,
			coordinator: coordinator,
			network: network_id
		});

		const Devices = await this.getCollection();

		let response = {
			device_id: device_id
		};
		
		if (coordinator) {

			//======= Generate Client Certificate =======//
			// get the certificate authority keys
			const keys = await getKeys();

			// generate a client certificate
			const certFactory = new ClientCertFactory(process.env.OPENSSL_BINARY_PATH, keys.ca.certificate);
			const clientCert = await certFactory.create_cert(keys.ca.key, "Spool Client " + device_id, false).catch((err) => {
				throw err
			});

			//======= Add the new device to the database =======//
			response.certificate = clientCert.certificate;
			response.private_key = clientCert.key;
			new_device.fingerprint = clientCert.fingerprint;
		}

		let devices = await Devices.insertOne(new_device).catch(err => {
			throw err;
		});

		//add device to user array
		const Users = await super.getCollection("Users");
		user.devices.push(device_id.toString());

		let userUpdate = Users.updateOne({_id: new ObjectID(user._id)}, {$set: {devices: user.devices}}).catch(err => {
			throw err
		});



		return response;
	}
}

module.exports = DeviceDatabase;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-access_devices.html">access/devices</a></li><li><a href="module-access_networks.html">access/networks</a></li><li><a href="module-access_visualization.html">access/visualization</a></li><li><a href="module-ClientCertFactory.html">ClientCertFactory</a></li><li><a href="module-manageKeys.html">manageKeys</a></li><li><a href="module-middleware.html">middleware</a></li></ul><h3>Classes</h3><ul><li><a href="DeviceDatabase.html">DeviceDatabase</a></li><li><a href="DeviceDataDatabase.html">DeviceDataDatabase</a></li><li><a href="module-ClientCertFactory-ClientCertFactory.html">ClientCertFactory</a></li><li><a href="VisualizationDatabase.html">VisualizationDatabase</a></li></ul><h3>Interfaces</h3><ul><li><a href="DatabaseInterface.html">DatabaseInterface</a></li></ul><h3>Global</h3><ul><li><a href="global.html#databaseWrap">databaseWrap</a></li><li><a href="global.html#strMapToObj">strMapToObj</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Thu Nov 21 2019 16:04:42 GMT-0800 (Pacific Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
