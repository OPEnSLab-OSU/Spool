<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: routes/device.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: routes/device.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Created by eliwinkelman on 7/9/19.
 */

var express = require('express');
var router = express.Router();
var wrapAsync = require('../lib/middleware/asyncWrap');

//MongoDB
var mongoClient = require('../javascript/db');
const ObjectID = require('mongodb').ObjectID;

//API JSON Schema Validation
var { Validator, ValidationError } = require('express-json-validator-middleware');
var validator = new Validator({allErrors: true});
// Define a shortcut function
var validate = validator.validate;
// TLS Client Authorization
var authorized = require('../lib/middleware/authorized');
const {RegisterDeviceSchema, PostDeviceDataSchema} = require('./api');

/**
 * @swagger
 * /device/data/:
 *    post:
 *      security:
 *         bearerAuth: []
 *      description: Accepts data from a Loom device and saves it to the database. It requires the device to be registered with the API and have the proper X509 Client Certificate issued by the API when the device was registered.
 *      requestBody:
 *          required: true
 *          content:
 *              'application/json':
 *                  schema:
 *                      type: object
 *                      required:
 *                          - device_id
 *                          - data_run
 *                          - data
 *                      properties:
 *                          device_id:
 *                              type: string
 *                              description: The id of the device given by spool during registration.
 *                          data_run:
 *                              type: string
 *                              description:
 *                          data:
 *                              type: object
 *                      example:
 *                          device_id: asdg034kajd024lc94
 *                          data_run: 0a4kjakd034nbdf92a
 *                          data: {}
 */

router.post('/data/', validate({body: PostDeviceDataSchema}), authorized(), wrapAsync(async function(req, res) {

	/*
	API Endpoint to save a new device datapoint into the database.

	 Request should look like
	 {
	 "device_id": &lt;string - Device ID> (specific to each piece of hardware reporting data)
	 "data_run": &lt;string - data run ID> (specific to each set of data collection)
	 "data" : &lt;json data provided from loom Manager.package()>
	 }
	 */
	
	// get the database client
	const client = await mongoClient().catch(err => {res.send(err)});
	
	//get the device id
	var device_id = req.body.device_id;
	const db = client.db('Loom');
	
	// device data collections are named by their device ID
	const DeviceData = db.collection(device_id.toString());
	
	var data = req.body;
	
	let newData = await DeviceData.insertOne(data).catch(err => {throw err;});
	if (newData) {
		res.sendStatus(200);
	}
	else {
		res.sendStatus(500)
	}
}));

module.exports = router;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-ClientCertFactory.html">ClientCertFactory</a></li><li><a href="module-middleware.html">middleware</a></li></ul><h3>Classes</h3><ul><li><a href="DeviceModel.html">DeviceModel</a></li><li><a href="module-ClientCertFactory-ClientCertFactory.html">ClientCertFactory</a></li></ul><h3>Global</h3><ul><li><a href="global.html#express">express</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#MongoClient">MongoClient</a></li><li><a href="global.html#RegisterDeviceSchema">RegisterDeviceSchema</a></li><li><a href="global.html#wrapAsync">wrapAsync</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Thu Sep 19 2019 15:23:09 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
